<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Material Process Tracking</title>

<style>
body{font-family:Arial;background:#f4f6f8;padding:10px}
h2{margin-top:0}
.tabBtn{padding:8px;margin:3px;background:#ccc;cursor:pointer;border:none;width:100%}
.tabBtn.active{background:#2c3e50;color:#fff}
.section{display:none;background:#fff;padding:10px;margin-top:8px}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
input,select,button{width:100%;padding:6px;margin:2px 0}
.ok{background:#2c3e50;color:#fff;border:none}
.ng{background:#b30000;color:#fff;border:none}
</style>
</head>

<body>

<h2>Material Process Tracking System</h2>

<div id="tabs"></div>
<div id="sections"></div>

<script>
/* ===== CONFIG ===== */
const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbxISEdCwxVqm5STH5hSk8rSSpdCo2RxsmmtJsiLFgA8it43nadif3OCTA0Rk96ZCXj7/exec";

const PROCESSES = [
  "Production",
  "Tempering",
  "Cleaning",
  "Vibro",
  "Plating",
  "Deburring",
  "Cutting",
  "Sorting",
  "QA",
  "Packing"
];

const tabsDiv = document.getElementById("tabs");
const sectionsDiv = document.getElementById("sections");

/* ===== BUILD UI ===== */
PROCESSES.forEach(p=>{
  const b=document.createElement("button");
  b.className="tabBtn";
  b.innerText=p;
  b.onclick=()=>openTab(p);
  tabsDiv.appendChild(b);

  sectionsDiv.innerHTML+=`
  <div id="${p}" class="section">
    <h3>${p}</h3>
    ${p==="Production"?productionForm():""}
    ${p!=="Production"?processTable(p):""}
  </div>`;
});

function productionForm(){
return `
<input id="part" placeholder="Part No">
<input id="wo" placeholder="Work Order No">
<input id="mc" placeholder="Machine No">
<input id="qty" placeholder="Quantity">
<input id="plant" placeholder="Plant">
<input id="shift" placeholder="Shift">
<input id="grn" placeholder="GRN / Coil No">

<label>Next Process</label>
<select id="next">
${PROCESSES.slice(1).map(p=>`<option>${p}</option>`).join("")}
</select>

<label>Handling Type</label>
<select id="ht"><option>Bin</option><option>Bag</option></select>
<input id="hq" placeholder="Qty per Bin / Bag">
<input id="hc" placeholder="No of Bins / Bags">

<button class="ok" onclick="releaseProduction()">Release Production</button>
`;
}

function processTable(p){
return `
<table>
<thead>
<tr>
<th>Part</th><th>Qty</th><th>GRN/Coil</th>
<th>Next Process</th><th>Remark</th><th>Action</th>
</tr>
</thead>
<tbody id="${p}_body"></tbody>
</table>`;
}

/* ===== TAB HANDLING ===== */
function openTab(p){
  document.querySelectorAll(".section").forEach(s=>s.style.display="none");
  document.querySelectorAll(".tabBtn").forEach(b=>b.classList.remove("active"));
  document.getElementById(p).style.display="block";
  [...tabsDiv.children].find(b=>b.innerText===p).classList.add("active");

  if(p!=="Production") loadProcess(p);
}

/* ===== PRODUCTION RELEASE ===== */
function releaseProduction(){
  fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({
      from_process:"Production",
      to_process:next.value,
      part_no:part.value,
      work_order_no:wo.value,
      machine_no:mc.value,
      quantity:qty.value,
      plant:plant.value,
      shift:shift.value,
      grn_coil_no:grn.value,
      handling_type:ht.value,
      handling_qty:hq.value,
      handling_count:hc.value
    })
  });
  alert("Production Released");
}

/* ===== LOAD PROCESS DATA ===== */
function loadProcess(p){
  fetch(`${SCRIPT_URL}?process=${p}`)
  .then(r=>r.json())
  .then(rows=>{
    const body=document.getElementById(p+"_body");
    body.innerHTML="";
    rows.forEach((r,i)=>{
      body.innerHTML+=`
      <tr>
        <td>${r.Part_No}</td>
        <td>${r.Quantity}</td>
        <td>${r.GRN_Coil_No}</td>
        <td>
          <select id="next_${p}_${i}">
            ${PROCESSES.filter(x=>x!==p)
              .map(x=>`<option>${x}</option>`).join("")}
          </select>
        </td>
        <td><input id="rm_${p}_${i}" placeholder="Remark mandatory"></td>
        <td>
          <button class="ok"
            onclick="processOK('${p}',${r._row},'${r.Part_No}','${r.GRN_Coil_No}',${r.Quantity},${i})">
            OK
          </button>
          <button class="ng"
            onclick="processNG('${p}',${r._row},'${r.Part_No}','${r.GRN_Coil_No}',${r.Quantity},${i})">
            NG
          </button>
        </td>
      </tr>`;
    });
  });
}

/* ===== OK / NG ===== */
function processOK(p,row,part,grn,qty,i){
  const remark=document.getElementById(`rm_${p}_${i}`).value;
  if(!remark){alert("Remark mandatory");return;}
  const next=document.getElementById(`next_${p}_${i}`).value;

  fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({
      current_process:p,
      next_process:next,
      _row:row,
      part_no:part,
      quantity:qty,
      grn_coil_no:grn,
      status:"OK",
      operator:p,
      remarks:remark
    })
  }).then(()=>loadProcess(p));
}

function processNG(p,row,part,grn,qty,i){
  const remark=document.getElementById(`rm_${p}_${i}`).value;
  if(!remark){alert("Remark mandatory");return;}

  fetch(SCRIPT_URL,{
    method:"POST",
    body:JSON.stringify({
      current_process:p,
      _row:row,
      part_no:part,
      quantity:qty,
      grn_coil_no:grn,
      status:"NG",
      operator:p,
      remarks:remark
    })
  }).then(()=>loadProcess(p));
}

/* ===== DEFAULT TAB ===== */
openTab("Production");
</script>

</body>
</html>
